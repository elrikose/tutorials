# Elastic Load Balancers (ELB)

## Load balancing

What is load balancing?

Servers that forward traffic to multiple servers downstream

Why a load balancer?

- Spread load
- Expose a single DNS access point to your application
- Handle failures of downstream server instances
- Health checks
- SSL termination
- High availability across zones
- Isolate public versus private traffic

Why use ELB?

- Managed load balancer
  - AWS manages upgrades, maintenance, etc
  - More expensive than a custom built LB, but less configuration.

- It is integrated with many AWS resources
  - EC2, ASGs, ECS, CloudWatch, Route 53, WAF, Global Accelerator

# Types of Load Balancers

- Classic Load Balancer (CLB) - v1 LB (deprecated)
- Application Load Balancer (ALB) - v2 LB - Only supports HTTP/HTTPS/WebSockets
- Network Load Balancer (NLB) - v2 LB - TCP, TLS, UDP
- Gateway Load Balancer (GWLB) - Operates at Layer 3

# Load Balancer Security Groups

The load balancer allows access from 0.0.0.0 on HTTPS/HTTP in a security group, but the backends often only support HTTP due to the termination and the security group of the load balancer of the source. For security reasons, only the Load Balancer source can hit the downstream EC2 instances.

# Classic Load Balancer

- Supports TCP, HTTP, and HTTPS.
- You get a fixed hostname XXX.region.elb.amazonaws.com
- It doesn't support IPv6

# Application Load Balancer (ALB)

- Supports only HTTP/HTTPS (Layer 7)
- Load balance to multiple HTTP targets groups/applications/containers
- Support for HTTP/2 and redirects
- Routing base on URL Path (foo.com/app1 or foo.com/app2)
- Routing base on URL domain name (app1.foo.com or app2.foo.com)
- Routing based on query string and headers (foo.com/?var1=1&var2=2)
- Perfect for microservices/containers.
- Feature to redirect to ECS dynamic port.
- Fixed hostname XXX.region.elb.amazonaws.com
- App servers don't see IP of client. True IP is inserted into HTTP headers (X-Forwarded-For)

Target Group targets can be:
- EC2 Instances
- ECS tasks
- Lamda function
- IP addresses

# Network Load Balancer (NLB)

- Forward TCP and UDP to your load balancers
- Handles millions of requests/s
- 100ms latency instead of 400ms for ALB
- NLB has 1 static IP per AZ and support Elastic IPs.
- Not free-tier

Target Group targets can be:
- EC2 Instances
- IP addresses
- ALB

# Gateway Load Balancer (GWLB)

- Deploy, scale and manage a fleet of network virtual appliances.
  - Firewalls
  - Intrusion detection and prevention systems
  - Deep Packet inspection
  - Payload manipulation

- Analyze all of the traffic and then decide if you want to pass it on to an application.
- Uses the GENEVE protocol on port 6081.

# Stickiness / Session Affinity for ELB

- Client stickiness from a user to a certain node behind the load balancer
- Works for CLB and ALB
- Uses a cookie for affinity
- Cookie can expire

Custom application based cookie
- Generated by target
- Custom metadata attributes needed for app

Regular cookie
- Cooke name is AWSALBAPP
- Created by LB.

Duration based
- Cooke name is AWSALB for ALB and AWSELB for CLB
- Created by LB.

# Cross-Zone Load Balancing

- Evenly distibutes load across all instances in all AZs.
- Without cross-zone it splits it evenly by lb. If there are 2 LBs, 50% of the traffic.

ALB - Always on can't disable, no charges
NLB - Disabled, charged for it if enabled
CLB - Disabled, no charges if enabled

# ELB and SSL

- HTTPS to the load balancer, HTTP over private VPC to target groups
- You manage certs wtih AWS Certificate Manager (ACM)
- You can upload your own certs too
- HTTPS listener must specify a default cert
- HTTPS listener can also contain a list of multiple domains.
- Clients use Server Name Indication (SNI) to specify the host they want to reach.

## Server Name Indication (SNI)

How do you load multiple certs for one web server. It uses SNI. The server finds the correct one

- Works for ALB, NLB, CloudFront
- Doesn't work for CLB since it is new. You can only use 1 SSL cert

# Connection Draining

- Connection Draining == Deregistration Delay
- Current requests are given enough time to deregister
- Stops sending new requests to other EC2 instances.
- Time to drain 1-3600 seconds
- Can be disable by setting to 0 seconds.
